<!DOCTYPE html>
<html>
<head>
    <title>ArcGIS REST with 256x256 Tiles</title>
    <link rel="stylesheet" href="../../lib/ol.css" type="text/css">
    <meta charset="UTF-8">
    <script src="../../lib/ol3.js"></script>
    <script src="../../lib/jquery-1.8.0.min.js"></script>
</head>
<body>
<div id="map" class="map"></div>
<script>

    var tileUrl = "http://10.20.2.101:8080/onemap/mapres/72b9486780f045a3ae976c7d180c82e7/MapServer";
    var tileArcGISXYZ;
    $.ajax({
        url: tileUrl + "?f=pjson",
        headers: {
            Authorization: "eyJhbGciOiJIUzUxMiJ9.eyJyYW5kb21LZXkiOiJyczc2NHAiLCJzdWIiOiLmmbrmhafmsLTliKnlr7nmjqUwMSIsImV4cCI6MTY2MDUyODc4MiwiaWF0IjoxNjU5OTIzOTgyfQ.yEwVTyBV6ZhZlKv2Da9nTroEvA6ixwq4B1ZvrnJr7ZiGjkcemQJBPQ6WlIFZezkJ7xWed9THXvxYphri9rLr9A"
        },
        // dataType: "json",
        success: function (res) {

            var data =res.data.metadata;

            var wkid  = data.spatialReference.latestWkid;
            var EPSG = 'EPSG:' + wkid;
            var projection = ol.proj.get(EPSG);



            var resolutions = [];
            var origin = [data.tileInfo.origin.x, data.tileInfo.origin.y];
            var len = data.tileInfo.lods.length;
            var fullExtent = [data.fullExtent.xmin, data.fullExtent.ymin, data.fullExtent.xmax, data.fullExtent.ymax];
            for (var i = 0; i < len; i++) {
                resolutions.push(data.tileInfo.lods[i].resolution);
            }
            var tileGrid = new ol.tilegrid.TileGrid({
                tileSize: data.tileInfo.cols,
                origin: origin,
                extent: fullExtent,
                resolutions: resolutions
            });
            var urlTemplate = tileUrl + "/tile/{z}/{y}/{x}";
            tileArcGISXYZ = new ol.source.XYZ({
                tileGrid: tileGrid,
                projection: projection,
                tileUrlFunction: function (tileCoord) {
                    var url = urlTemplate.replace('{z}', (tileCoord[0]).toString())
                        .replace('{x}', tileCoord[1].toString())
                        .replace('{y}', (-tileCoord[2] - 1).toString());
                    return url;
                },
                tileLoadFunction: function (imageTile, src) {
                    const xhr = new XMLHttpRequest();
                    xhr.responseType = 'blob';
                    xhr.addEventListener('loadend', function (evt) {
                        const data = this.response;
                        if (data !== undefined) {
                            imageTile.getImage().src = URL.createObjectURL(data);
                        } else {

                        }
                    });
                    xhr.addEventListener('error', function () {

                    });

                    xhr.open('GET', src);
                    xhr.setRequestHeader("Authorization", "eyJhbGciOiJIUzUxMiJ9.eyJyYW5kb21LZXkiOiJyczc2NHAiLCJzdWIiOiLmmbrmhafmsLTliKnlr7nmjqUwMSIsImV4cCI6MTY2MDUyODc4MiwiaWF0IjoxNjU5OTIzOTgyfQ.yEwVTyBV6ZhZlKv2Da9nTroEvA6ixwq4B1ZvrnJr7ZiGjkcemQJBPQ6WlIFZezkJ7xWed9THXvxYphri9rLr9A");
                    xhr.send();

                }
            });

            var centerX = (fullExtent[0] + fullExtent[2])/2;
            var centerY = (fullExtent[1] + fullExtent[3])/2;

            var map = new ol.Map({
                controls: [new ol.control.ScaleLine()],
                target: 'map',
                layers: [
                    new ol.layer.Tile({
                        source: tileArcGISXYZ
                    })
                ],
                view: new ol.View({
                    center: [centerX,centerY],
                    zoom: 10,
                    projection: projection,
                    extent: fullExtent
                })
            });

            tileArcGISXYZ.on("tileloadend", function (ev) {
                console.log("加载失败!!!");
            });

        },
        error: function (err) {
            console.error(err);
        }
    });
</script>
</body>
</html>